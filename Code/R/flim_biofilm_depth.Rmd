---
title: "flim_biofilm"
output: html_document
---
```{r packages}
require(dplyr)
require(ggplot2)
require(gridExtra)
require(grid)
require(extrafont)
require(ggforce)
require(scales)
library(RColorBrewer)
library(data.table)
library(fasano.franceschini.test)

```


```{r colors and shapes}

circleFun <- function(center = c(0.5,0),diameter = 1 , npoints = 100){
    r = diameter / 2
    tt <- seq(0,2*pi,length.out = npoints)
    xx <- center[1] + r * cos(tt)
    yy <- center[2] + r * sin(tt)
    return(data.frame(x = xx, y = yy))
}

circle1<- circleFun()


color_map_1<-c(
  "Enzyme-bound NADH"="#0072b2",
  "MDH NADH"= "#0072b2", 
  "Free NADH"= "#e69f00",
   "PVD"="#d55e00",
  "PYO"="#56b4e9", 
  "PYO (Reduced)" = "#56b4e9",
  "OHPhz (Reduced)" = "#009e73", 
  "FAD" = "#EE9B00" , 
   "CPX" = "#9B2226" ,
  "OLS" = "black" , 
  "PVD + Fe" = "#f0e442" )

color_map_2<-c(
  "Enzyme-bound NADH"="#272727",
  "MDH NADH"="#272727",
  "Free NADH"="#696773",
   "PVD"="#FED766",
  "PYO"="#009FB7")

#EFF1F3

shape_maps<-c(
  "Enzyme-bound NADH"=22,
  "MDH NADH"=22,
  "Free NADH"=23,
   "PVD"=24,
  "PYO"=25 , 
  "PYO (Reduced)" = 25 , 
  "OHPhz (Reduced)" = 21,
  "FAD" = 21 , 
  "CPX" = 22 ,
  "OLS" = 22)


# media color maps
media_colors <- c(
  "ASM" = "#444444", 
  "M9 suc" = "#D3B2D9" ,
  "M9 suc+sup" = "#FF7700" )

media_shapes <- c(
  "ASM" = 21 , 
  "M9 suc" = 22  ,
  "M9 suc+sup" = 23 )

color_shape_maps<-c(
  "Enzyme-bound NADH"= 0,
  "MDH NADH"= 0,
  "Free NADH"=5,
   "PVD"= 2 ,
  "PYO"= 6 )

# gradient color map
yellow_blue_1 <- c('#EDF8B1',  '#C7E9B4' , "#41B6C4" , "#225EA8" , "#081D58" )
yellow_blue <- c('#EDF8B1',  '#C7E9B4' , "#41B6C4" , "#225EA8"  )
yellow_red <- c("#ffba08", "#f48c06",  "#dc2f02", "#9d0208") 
green_red_1 <- c("#90BE6D" , "#F9C74F", "#F8961E", "#F3722C" ,  "#F94144")
green_red <- c("#90BE6D" , "#F9C74F",  "#F94144")
blue_yellow_orange <- c("#3BCFD4", "#D7FC05", "#EC6E20")
purple_green <- c('#7C65A9' ,"#96D4CA") 
blue_green_orange <- c("#0088FF" ,"#5BCA7A" ,  "#FF6200")
white_black <- c("#F8F8FF", "#CAC9CD" ,  "#9B9A9C" , "#6D6A6A" , "#3E3B39" , "#100C07" )

# depth
depth_colors <- c("#1295E4", "#36AFAF", "#5BCA7A", "#9CA049", "#BD8B30" , "#DE7618" , "#B7094C" , "#A01A58" , "#892B64", "#723C70", "#5C4D7D")

depth_lines <- c("solid", "dotted", "dashed", "longdash", "solid", "dotted", "dashed", "longdash",  "dotted", "dashed", "solid")

```


```{r paths and data}
# reference means 
ref <- read.csv( file = "/Users/Tara//Documents/GitHub/PseudomonasFLIM/Data/Processed/ref_flim_means.csv")

# biofilm depth data
# g and s data
biofilm <- read.csv(file =  '/Users/Tara/Documents/GitHub/PseudomonasFLIM/Data/Processed/df_biofilm_flim.csv', header=T)

```



```{r lifetime phasor }

phasorFun <- function(omega,time){
  #convert megaheartz to nanoseconds
  NS =omega*2*pi/1000
  g=1/(1+(NS*time)^2)
  s=NS*time/(1+(NS*time)^2)
 return(data.frame(mean_g1=g, mean_s1=s, lifetime=time))
}


enzymeNADH<-phasorFun(80,3.2)
phasorFun(80,10)
enzymeNADH$object<-c("Enzyme-bound NADH")

oxlipid<-phasorFun(80,7.8)

oxlipid$object<-c("OLS")

ref <- rbind(ref, enzymeNADH)
ref <- rbind(ref, oxlipid)

```


```{r format biofilm flim data}

# get depth from filename
biofilm$depth <- gsub(pattern = ".*[0-9]p_", replacement="", x= biofilm$FileName )
biofilm$depth <- gsub(pattern = "CG0T.*" , replacement = "", x=biofilm$depth)
biofilm$depth <- gsub(pattern = "d.*" , replacement = "", x=biofilm$depth)

# get strain (wt vs phz ko)
biofilm$strain <- ifelse( grepl(x=biofilm$condition, pattern="WT"), "WT", "Δphz") 

# get media (asm or m9 succinate)
biofilm$media <- ifelse( grepl(x=biofilm$condition, pattern="ASM"), "ASM", "M9 suc") 



biofilm <- subset(biofilm, FileName!="/Users/sltg/Documents/GitHub/PseudomonasFLIM/Data/FLIM/biofilm/phzko_ASM/plate1/45p_75d000$CG0T_0-1__ch1_h1_h2.R64")

```




```{r plot phasor}

# order biofilm depth 
biofilm$depth <- factor(as.character(biofilm$depth))
levels(biofilm$depth) <- c("0","100","200","300", "400","500","600","700","800","900","1000")


biofilm_phasor <- ggplot() + 
  geom_path(data=subset(circle1, y>0),aes(x=x,y=y))+
  geom_bin2d(data = biofilm, aes(x=g1, y=s1 ), bins=150)+
  facet_grid(.~strain + media )+
  scale_fill_gradientn( colors = rev(yellow_blue), "Number \n of pixels",
                        labels = label_scientific())+
   theme( plot.background = element_rect(fill="white", color="white"),
        panel.background = element_rect(fill="white", color="black"),
        panel.grid = element_blank(), 
        axis.text=element_text(color="black",size=12),
        axis.ticks=element_blank(),
        axis.title.y = element_text(color="black", size=12),
      axis.title.x= element_text(color="black", size=12),
        strip.background = element_rect(color="black", fill="white"),
        strip.text =element_text(color="black", size=12),
                               legend.text=element_text(size=10),
     strip.text.y=element_text(angle=0),
     strip.text.x=element_text(angle=0),
   plot.title = element_text(hjust = 0.5, size=12),
        legend.title=element_text(size=10) ,
   legend.background = element_rect(color='white' , fill='white'),
   legend.key = element_rect(color='white', fill='white'),
   legend.position = 'none' ) +
    xlab(expression('G=M'%*%'cos('~phi~')'))+
  ylab(expression('S=M'%*%'sin('~phi~')'))+
    geom_path(data=subset(circle1, y>0),aes(x=x,y=y))+
  scale_x_continuous(breaks=pretty_breaks(n=3))+
  scale_y_continuous(breaks=pretty_breaks(n=3), limits = c(0,1))+
  geom_point( data = ref, aes(x=mean_g1, y=mean_s1, shape=object), fill="black", size=3)+
  scale_shape_manual( values = shape_maps )


biofilm_phasor_gradientonly <- 
   ggplot() + 
  geom_path(data=subset(circle1, y>0),aes(x=x,y=y))+
  geom_bin2d(data = biofilm, aes(x=g1, y=s1 ), bins=150)+
  scale_fill_gradientn( colors = rev(yellow_blue), "Number \n of pixels",
                        labels = label_scientific( digits=1),  breaks=c(10000, 50000) ) +
   theme( plot.background = element_rect(fill="white", color="white"),
        panel.background = element_rect(fill="white", color="black"),
        panel.grid = element_blank(), 
        axis.text=element_text(color="black",size=12),
        axis.ticks=element_blank(),
        axis.title.y = element_text(color="black", size=12),
      axis.title.x= element_text(color="black", size=12),
        strip.background = element_rect(color="black", fill="white"),
        strip.text =element_text(color="black", size=12),
                               legend.text=element_text(size=10),
     strip.text.y=element_text(angle=0),
     strip.text.x=element_text(angle=0),
   plot.title = element_text(hjust = 0.5, size=12),
   plot.margin =margin(l=10), 
        legend.title=element_text(size=10) ,
   legend.background = element_rect(color='white' , fill='white'),
   legend.key = element_rect(color='white', fill='white'),
   legend.position = 'bottom' ) +
    xlab(expression('G=M'%*%'cos('~phi~')'))+
  ylab(expression('S=M'%*%'sin('~phi~')'))+
    geom_path(data=subset(circle1, y>0),aes(x=x,y=y))+
  scale_x_continuous(breaks=pretty_breaks(n=3))+
  scale_y_continuous(breaks=pretty_breaks(n=3), limits = c(0,1))
  

biofilm_gradient_legend <- cowplot::get_legend(biofilm_phasor_gradientonly)

g1_density <- ggplot() + geom_density(data = biofilm, aes(x = g1, color = depth, linetype = depth )) + 
  facet_grid(strain+media~. ) +
  scale_color_manual( values = depth_colors,"Depth (µm)"  )+
  theme( plot.background = element_rect(fill="white", color="white"),
        panel.background = element_rect(fill="white", color="black"),
        panel.grid = element_blank(), 
        axis.text.x=element_text(color="black",size=12),
        axis.text.y = element_blank(),
        axis.ticks=element_blank(),
        axis.title = element_text(color="black", size=12),
        strip.background = element_rect(color="black", fill="white"),
        strip.text =element_text(color="black", size=12),
                               legend.text=element_text(size=12),
     strip.text.y=element_text(angle=0),
     strip.text.x=element_text(angle=0),
   plot.title = element_text(hjust = 0.5, size=12),
        legend.title= element_text(size=12, color='black'),
   legend.position='none',
   legend.key =  element_rect(fill='white', color='white'))+
  xlab("G")+
  ylab("Density")+
  scale_x_continuous( breaks=pretty_breaks(n=3), limits = c(0,1))+
  scale_linetype_manual(values = depth_lines, "Depth (µm)")


s1_density <- ggplot() + geom_density(data = biofilm, aes(x = s1, color = depth, linetype = depth )) + 
  facet_grid(strain+media~. ) +
  scale_color_manual( values = depth_colors,"Depth (µm)"  )+
  theme( plot.background = element_rect(fill="white", color="white"),
        panel.background = element_rect(fill="white", color="black"),
        panel.grid = element_blank(), 
        axis.text.x =element_text(color="black",size=12),
        axis.ticks=element_blank(),
        axis.text.y= element_blank(),
        axis.title = element_text(color="black", size=12),
        strip.background = element_rect(color="black", fill="white"),
        strip.text =element_text(color="black", size=12),
                               legend.text=element_text(size=12),
     strip.text.y=element_text(angle=0),
     strip.text.x=element_text(angle=0),
   plot.title = element_text(hjust = 0.5, size=12),
        legend.title= element_text(size=12, color='black'), 
   legend.key =  element_rect(fill='white', color='white'))+
  xlab("S")+
  ylab("Density")+
  scale_x_continuous( breaks=pretty_breaks(n=3), limits = c(0,0.55))+
  scale_linetype_manual(values = depth_lines, "Depth (µm)")

```


```{r figure 3 grids}

tablea<-textGrob(c("A"), gp=gpar(fontsize=40), vjust=c(-1,0), hjust=c(.5,0))
tableb<-textGrob(c("B"), gp=gpar(fontsize=40), vjust=c(-1,0), hjust=c(.5,0))
tablec<-textGrob(c("C"), gp=gpar(fontsize=40), vjust=c(-1,0), hjust=c(.5,0))


panel_a<- arrangeGrob( arrangeGrob(tablea, biofilm_phasor, ncol=2, widths=c(1,12)), biofilm_gradient_legend, nrow=2, heights=c(3,1),padding = c(.1) )


panel_b <- arrangeGrob(tableb, g1_density , ncol=2, widths=c(1,12))
panel_c <- arrangeGrob(tablec, s1_density , ncol=2, widths=c(1,12))

panel_bc <- arrangeGrob(panel_b,panel_c, ncol=2, widths=c(1,1.2))

figure3 <- arrangeGrob(panel_a, panel_bc, nrow=2, heights=c(2,3))

ggsave(plot=figure3,filename ="/Users/Tara/Documents/GitHub/PseudomonasFLIM/Output/Paper/Figures/fig3_biofilm_phasor.eps", device ='eps', height=8, width=8 )

```

